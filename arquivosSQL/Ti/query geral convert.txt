--GERAL

/*
PAGAMENTOS
*/


SELECT
  TO_CHAR(PCLANC.CODFILIAL) AS FILIAL,
  TO_CHAR(PCCONTA.TIPO) AS TIPO, 
  TO_CHAR(PCCONTA.GRUPOCONTA) AS GRUPOCONTA,
  TO_CHAR(PCLANC.CODCONTA) AS CODCONTA,
  TO_CHAR(PCCONTA.CONTA) AS CONTA,
  TO_CHAR(PCFORNEC.FORNECEDOR) AS FORNECEDOR,
  TO_CHAR(NVL(PCLANC.VALOR, 0)) AS VALOR, 
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR(NVL(PCLANC.VPAGO, 0)) AS VPAGO, 
  TO_CHAR(NVL(PCLANC.VPAGOBORDERO, 0)) AS VPAGOBORDERO, 
  TO_CHAR('0') AS VDEV,
  TO_CHAR(NVL(PCLANC.VPAGO, 0)) AS VALORPAGO, 
  TO_CHAR(PCLANC.DTVENC, 'YYYY-MM-DD') AS VENCIMENTO,
  TO_CHAR(PCLANC.DTPAGTO, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR(PCGRUPO.GRUPO) AS GRUPO

FROM 
  PCLANC, 
  PCCONTA, 
  PCNFSAID, 
  PCCONSUM,
  PCFORNEC,
  PCGRUPO
WHERE 
  0 = 0 
  AND PCCONTA.GRUPOCONTA = PCGRUPO.CODGRUPO 
  AND PCLANC.CODFORNEC = PCFORNEC.CODFORNEC(+) 
  AND PCLANC.CODCONTA = PCCONTA.CODCONTA(+) 
  AND PCLANC.NUMTRANSVENDA = PCNFSAID.NUMTRANSVENDA(+) 
  AND NVL(PCLANC.CODROTINABAIXA, 0) <> 737 
  AND (SELECT COUNT(D.NUMTRANSENT) 
       FROM PCESTCOM D, PCNFSAID N 
       WHERE D.NUMTRANSENT = PCLANC.NUMTRANSENT 
         AND D.DTESTORNO = PCLANC.DTLANC 
         AND D.NUMTRANSVENDA = N.NUMTRANSVENDA 
         AND N.CONDVENDA IN (20)) = 0 
  AND NVL(PCNFSAID.CONDVENDA, 0) NOT IN (10, 20, 98, 99) 
  AND (NVL(PCNFSAID.CODFISCAL, 0) NOT IN (522, 622, 722, 532, 632, 732) 
       OR TO_CHAR(PCLANC.CODCONTA) = (SELECT VALOR FROM PCPARAMFILIAL WHERE NOME = 'CON_CODCONTRECJUR'))
  AND PCLANC.DTPAGTO IS NOT NULL
  AND NVL(PCCONTA.INVESTIMENTO, 'N') <> 'S'
  AND PCCONTA.GRUPOCONTA BETWEEN 200 AND 900 
  AND PCLANC.CODFILIAL IN ('2', '3', '4')

UNION ALL

/*
DEVOLUÇÕES
*/

SELECT 
  TO_CHAR(CODFILIAL) AS FILIAL,
  TO_CHAR('D') AS TIPO,
  TO_CHAR('101') AS GRUPOCONTA,
  TO_CHAR('105') AS CODCONTA,
  TO_CHAR('DEVOLUÇÕES') AS CONTA,
  TO_CHAR(FORNECEDOR) AS FORNECEDOR,
  TO_CHAR(VLDEVOLUCAO) AS VALOR,
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR('0') AS VPAGO,
  TO_CHAR('0') AS VPAGOBORDERO,
  TO_CHAR('0') AS VDEV,
  TO_CHAR(VLDEVOLUCAO) AS VALORPAGO,
  TO_CHAR(NULL) AS VENCIMENTO,
  TO_CHAR(DTENT, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR('VENDA FATURADA') AS GRUPO

FROM 
  VIEW_DEVOL_RESUMO_FATURAMENTO

WHERE 
  1 = 1 
  AND CONDVENDA NOT IN (4, 8, 10, 13, 20, 98, 99)
  
 UNION ALL
  
 /*
DEVOLUÇÕES AVULSO
*/
SELECT 
  TO_CHAR(CODFILIAL) AS FILIAL,
  TO_CHAR('D') AS TIPO,
  TO_CHAR('101') AS GRUPOCONTA,
  TO_CHAR('105') AS CODCONTA,
  TO_CHAR('DEVOLUÇÕES') AS CONTA,
  TO_CHAR(CLIENTE) AS FORNECEDOR,
  TO_CHAR(VLDEVOLUCAO) AS VALOR,
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR('0') AS VPAGO,
  TO_CHAR('0') AS VPAGOBORDERO,
  TO_CHAR('0') AS VDEV,
  TO_CHAR(VLDEVOLUCAO) AS VALORPAGO,
  TO_CHAR(NULL) AS VENCIMENTO,
  TO_CHAR(DTENT, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR('VENDA FATURADA') AS GRUPO

FROM VIEW_DEVOL_RESUMO_FATURAVULSA

UNION ALL

/* OUTROS FATURAMENTOS / SERVIÇOS */

SELECT
  TO_CHAR(CODFILIAL) AS FILIAL,
  TO_CHAR('C') AS TIPO,
  TO_CHAR('101') AS GRUPOCONTA,
  TO_CHAR('108') AS CODCONTA,
  TO_CHAR('VENDA DE SERVIÇOS') AS CONTA,
  TO_CHAR(CLIENTE) AS FORNECEDOR,
  TO_CHAR(VLTOTAL) AS VALOR,
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR('0') AS VPAGO,
  TO_CHAR('0') AS VPAGOBORDERO,
  TO_CHAR('0') AS VDEV,
  TO_CHAR(VLTOTAL) AS VALORPAGO,
  TO_CHAR(NULL) AS VENCIMENTO,
  TO_CHAR(DTSAIDA, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR('VENDA FATURADA') AS GRUPO

FROM PCNFSAID 
WHERE ESPECIE IN ('NS', 'CO') 
  AND (TIPOVENDA IN ('VP', 'VV') OR ((TIPOVENDA = 'SE' AND EXISTS (SELECT 1 
                                                                   FROM PCMOV M 
                                                                   WHERE M.NUMTRANSVENDA = PCNFSAID.NUMTRANSVENDA 
                                                                     AND PCNFSAID.DTSAIDA = M.DTMOV 
                                                                   )))) 
  AND VLTOTGER > 0 
  AND NVL(PCNFSAID.CONDVENDA, -1) IN (-1, 1, 5, 7, 9, 11, 14) 
  AND NVL(PCNFSAID.CODFISCAL, 0) NOT IN (522, 622, 722, 532, 632, 732)

UNION ALL

/* FATURAMENTOS */

SELECT
  TO_CHAR(CODFILIAL) AS FILIAL,
  TO_CHAR('C') AS TIPO,
  TO_CHAR('101') AS GRUPOCONTA,
  TO_CHAR('101') AS CODCONTA,
  TO_CHAR('VENDA FATURADA') AS CONTA,
  TO_CHAR(CLIENTE) AS FORNECEDOR,
  TO_CHAR(VLVENDA) AS VALOR,
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR('0') AS VPAGO,
  TO_CHAR('0') AS VPAGOBORDERO,
  TO_CHAR('0') AS VDEV,
  TO_CHAR(VLVENDA) AS VALORPAGO,
  TO_CHAR(NULL) AS VENCIMENTO,
  TO_CHAR(DTSAIDA, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR('VENDA FATURADA') AS GRUPO

FROM VIEW_VENDAS_RESUMO_FATURAMENTO VENDAS
WHERE 1 = 1 
  AND VENDAS.ESPECIE IN ('NF') 
  AND NVL(VENDAS.CONDVENDA, -1) IN (-1, 1, 5, 7, 9, 11, 14) 
  AND NVL(VENDAS.CODFISCAL, 0) NOT IN (522, 622, 722, 532, 632, 732)
  AND (VENDAS.DTCANCEL IS NULL)

UNION ALL  

/* CMV VENDAS */

SELECT
  TO_CHAR(CODFILIAL) AS FILIAL,
  TO_CHAR('D') AS TIPO,
  TO_CHAR('102') AS GRUPOCONTA,
  TO_CHAR('4') AS CODCONTA,
  TO_CHAR('CMV DA VENDA FATURADA') AS CONTA,
  TO_CHAR(CLIENTE) AS FORNECEDOR,
  TO_CHAR(VLCUSTOFINB) AS VALOR,
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR('0') AS VPAGO,
  TO_CHAR('0') AS VPAGOBORDERO,
  TO_CHAR('0') AS VDEV,
  TO_CHAR(VLCUSTOFINB) AS VALORPAGO,
  TO_CHAR(NULL) AS VENCIMENTO,
  TO_CHAR(DTSAIDA, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR('CMV DA VENDA FATURADA') AS GRUPO

FROM VIEW_VENDAS_RESUMO_FATURAMENTO VENDAS
WHERE 1 = 1 
  AND VENDAS.ESPECIE IN ('NF') 
  AND NVL(VENDAS.CONDVENDA, -1) IN (-1, 1, 5, 7, 9, 11, 14) 
  AND NVL(VENDAS.CODFISCAL, 0) NOT IN (522, 622, 722, 532, 632, 732)
  AND (VENDAS.DTCANCEL IS NULL)

UNION ALL  

/* CMV DEVOLUÇÕES */

SELECT 
  TO_CHAR(CODFILIAL) AS FILIAL,
  TO_CHAR('C') AS TIPO,
  TO_CHAR('102') AS GRUPOCONTA,
  TO_CHAR('104') AS CODCONTA,
  TO_CHAR('CMV DA VENDA FATURADA') AS CONTA,
  TO_CHAR(FORNECEDOR) AS FORNECEDOR,
  TO_CHAR(VLCMVDEVOL) AS VALOR,
  TO_CHAR('0') AS VDESC,
  TO_CHAR('0') AS VJURO,
  TO_CHAR('0') AS VPAGO,
  TO_CHAR('0') AS VPAGOBORDERO,
  TO_CHAR('0') AS VDEV,
  TO_CHAR(VLCMVDEVOL) AS VALORPAGO,
  TO_CHAR(NULL) AS VENCIMENTO,
  TO_CHAR(DTENT, 'YYYY-MM-DD') AS COMPENSACAO,
  TO_CHAR('CMV DA VENDA FATURADA') AS GRUPO

FROM VIEW_DEVOL_RESUMO_FATURAMENTO
WHERE 1 = 1 
  AND CONDVENDA NOT IN (4, 8, 10, 13, 20, 98, 99);
